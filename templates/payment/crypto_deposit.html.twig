{% extends 'base.html.twig' %}

{% block title %}Instructions de dépôt{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const expiresAt = new Date('{{ expiresAt|date('Y-m-d H:i:s') }}').getTime();
            
            function updateTimer() {
                const now = new Date().getTime();
                const distance = expiresAt - now;
                
                if (distance < 0) {
                    document.getElementById('timer').innerHTML = "Expiré";
                    return;
                }
                
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                document.getElementById('timer').innerHTML = 
                    `${hours}h ${minutes}m ${seconds}s`;
            }
            
            updateTimer();
            setInterval(updateTimer, 1000);
            
            // Vérification automatique du statut
            setInterval(function() {
                fetch('{{ path('app_check_crypto_deposit', {'id': transaction.id}) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `_token={{ csrf_token('crypto_deposit') }}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'completed') {
                        window.location.reload();
                    } else if (data.status === 'expired') {
                        window.location.reload();
                    }
                });
            }, 30000); // Toutes les 30 secondes
        });
    </script>
{% endblock %}

{% block body %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Instructions pour votre dépôt</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>Attention :</strong> Ce dépôt expirera dans <span id="timer"></span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <h5>Montant à envoyer</h5>
                                <div class="display-4 text-success">
                                    {{ amount|number_format(2) }} USD
                                </div>
                                <small class="text-muted">en {{ network }}</small>
                            </div>
                            
                            <div class="mb-4">
                                <h5>Adresse de dépôt</h5>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" id="depositAddress" 
                                           value="{{ depositAddress }}" readonly>
                                    <button class="btn btn-outline-secondary" type="button"
                                            onclick="copyToClipboard('depositAddress')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Envoyez uniquement {{ network }} à cette adresse</small>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                Les dépôts prennent généralement 1-3 confirmations avant d'être crédités.
                            </div>
                        </div>
                        
                        <div class="col-md-6 text-center">
                            <div class="mb-3">
                                <img src="{{ qrCodeUrl }}" alt="QR Code" class="img-fluid" style="max-width: 250px;">
                            </div>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="window.location.reload()">
                                <i class="bi bi-arrow-clockwise"></i> Actualiser
                            </button>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ path('app_profile') }}" class="btn btn-outline-secondary">
                            Retour au profil
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function copyToClipboard(elementId) {
        const copyText = document.getElementById(elementId);
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        document.execCommand("copy");
        
        // Afficher un tooltip ou une notification
        const originalText = event.target.innerHTML;
        event.target.innerHTML = '<i class="bi bi-check"></i> Copié';
        setTimeout(() => {
            event.target.innerHTML = originalText;
        }, 2000);
    }
</script>
{% endblock %}