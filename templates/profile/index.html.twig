{% extends 'base.html.twig' %}

{% block title %}{{ app.user.fname }} {{ app.user.lname }} | Profil{% endblock %}

{% block body %}
	<style>
		body {
			background: linear-gradient(135deg, #FFA500, #1E90FF);
			min-height: 100vh;
			color: #fff;
			font-family: 'Arial', sans-serif;
		}
		.profile-card {
			background-color: rgba(255, 255, 255, 0.15);
			backdrop-filter: blur(10px);
			border-radius: 15px;
			padding: 30px;
			margin-top: 50px;
			box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
		}
		.profile-img {
			width: 100px;
			height: 100px;
			object-fit: cover;
			border: 5px solid #fff;
			border-radius: 50%;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
		}
		.btn-deposit,
		.btn-withdraw,
		.btn-edit {
			border: none;
			color: #fff;
			padding: 10px 20px;
			border-radius: 5px;
			transition: background-color 0.3s;
			text-decoration: none;
		}
		.btn-deposit {
			background-color: #FFA500;
		}
		.btn-deposit:hover {
			background-color: #e69500;
		}
		.btn-withdraw {
			background-color: #1E90FF;
		}
		.btn-withdraw:hover {
			background-color: #187bcd;
		}
		.btn-edit {
			background-color: #28a745;
		}
		.btn-edit:hover {
			background-color: #218838;
		}
		.btn-share {
			background-color: #17a2b8;
			color: #fff;
		}
		.btn-share:hover {
			background-color: #138496;
		}
		.table-custom {
			background-color: rgba(255, 255, 255, 0.2);
		}
		.table-custom th,
		.table-custom td {
			color: #fff;
		}
		.table-custom thead th {
			border-bottom: 2px solid rgba(255, 255, 255, 0.5);
		}
	</style>

	<div class="container">
		<div class="row justify-content-center py-5 mt-3">
			<div class="col-md-8 profile-card">
				<div class="d-flex align-items-center mb-4">
					{% if app.user.googleId and app.user.photo starts with 'http' %}
						<img src="{{ app.user.photo }}" alt="Photo de profil" class="profile-img me-3 img-fluid">
					{% else %}
						<img src="/uploads/users/{{ app.user.photo }}" alt="Photo de profil" class="profile-img me-3 img-fluid">
					{% endif %}
					<div class="float-start">
						<h2 class="mb-0">{{ app.user.fname }} {{ app.user.lname }}</h2>
						<small class="text-muted">{{ app.user.username }}</small>
						<p>{{ app.user.email }}</p>
						<h5>Solde:
							<span class="fw-bold">${{ app.user.balance }}</span>
						</h5>
					</div>
				</div>

				<div class="mb-4">
					<a href="{{ path('app_user_settings') }}" class="btn-edit btn btn-success mb-3">Modifier le profil</a>
					<a href="#" class="btn-deposit btn btn-warning mb-3" data-bs-toggle="modal" data-bs-target="#depositModal">Faire un dépôt</a>
					<a href="#" class="btn-withdraw btn btn-primary" data-bs-toggle="modal" data-bs-target="#withdrawModal">Retirer des fonds</a>

					<!-- Bouton de partage du lien d'affiliation -->
					<button class="btn-share btn mt-3" data-bs-toggle="modal" data-bs-target="#shareModal">
						Partager mon lien d'affiliation
					</button>
				</div>

				<div>
					<h4>Historique des transactions</h4>
					<div class="table-responsive">
						<table class="table table-custom table-striped">
							<thead>
								<tr>
									<th>Date</th>
									<th>Méthode</th>
									<th>Montant</th>
								</tr>
							</thead>
							<tbody>
								{% for transaction in transactions %}
									<tr>
										<td>{{ transaction.createdAt|date('d/m/Y') }}</td>
										<td>{{ transaction.method }}</td>
										<td>${{ transaction.amount }}</td>
									</tr>
								{% else %}
									<tr>
										<td colspan="3">Aucune transaction trouvée.</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Dépôt -->
	<div class="modal fade" id="depositModal" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content" style="color:#000;">
				<div class="modal-header">
					<h5 class="modal-title" id="depositModalLabel">Faire un dépôt</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="depositForm" action="{{ path('app_deposit') }}" method="post">
						<div class="mb-3">
							<label for="amount" class="form-label">Montant (Dollar USD)</label>
							<input type="number" name="amount" required class="form-control">
						</div>
						<div class="mb-3">
							<label for="paymentMethod" class="form-label">Méthode de paiement</label>
							<select name="paymentMethod" id="paymentMethod" required class="form-control">
								<option value="">-- Choisissez --</option>
								<option value="crypto">Crypto</option>
								<option value="paypal">PayPal</option>
								<option value="mobilemoney">Mobile Money</option>
								<option value="carte">Carte</option>
							</select>
						</div>
						<button type="submit" class="btn-deposit">Déposer</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Retrait -->
	<div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content" style="color:#000;">
				<div class="modal-header">
					<h5 class="modal-title" id="withdrawModalLabel">Retirer des fonds</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form action="{{ path('app_withdraw') }}" method="post">
						<div class="mb-3">
							<label for="amount" class="form-label">Montant (USDT)</label>
							<input type="number" name="amount" required class="form-control">
						</div>
						<div class="mb-3">
							<label for="recipient" class="form-label">Adresse de réception</label>
							<input type="text" name="recipient" required class="form-control">
						</div>
						<button type="submit" class="btn-withdraw">Retirer</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal de partage du lien d'affiliation -->
	<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content" style="color:#000;">
				<div class="modal-header">
					<h5 class="modal-title" id="shareModalLabel">Partager mon lien d'affiliation</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>
						Votre lien d’affiliation&nbsp;:
						<strong>{{ referralLink }}</strong>
					</p>
					<button class="btn btn-secondary mb-3" onclick="copyToClipboard('{{ referralLink }}')">
						Copier le lien
					</button>
					<hr>
					<!-- Partage sur WhatsApp -->
					<a class="btn btn-success mb-2 w-100" href="https://api.whatsapp.com/send?text={{ ('Rejoignez-moi sur cette plateforme: ' ~ referralLink)|url_encode }}" target="_blank">
						Partager via WhatsApp
					</a>
					<!-- Partage sur Facebook -->
					<a class="btn btn-primary mb-2 w-100" href="https://www.facebook.com/sharer/sharer.php?u={{ referralLink|url_encode }}" target="_blank">
						Partager sur Facebook
					</a>
					<!-- Partage sur Twitter -->
					<a class="btn btn-info mb-2 w-100" href="https://twitter.com/intent/tweet?text=Rejoignez-moi%20sur%20cette%20plateforme%20{{ referralLink|url_encode }}" target="_blank">
						Partager sur Twitter
					</a>
				</div>
			</div>
		</div>
	</div>

	<!-- Conteneur du toast pour la notification de copie -->
	<div class="position-fixed top-0 end-0 p-3" style="z-index: 2000">
		<div id="copyToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="d-flex">
				<div class="toast-body">
					Lien copié dans le presse-papier !
				</div>
				<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
		</div>
	</div>

	<script>
		// Interception de la soumission pour rediriger vers le flux PayPal
		document.getElementById('depositForm').addEventListener('submit', function(e) {
			var paymentMethod = document.getElementById('paymentMethod').value;
			if (paymentMethod === 'paypal') {
				e.preventDefault();
				var amount = document.querySelector('input[name="amount"]').value;
				// Redirection vers le endpoint de redirection PayPal
				window.location.href = "{{ path('app_paypal_redirect') }}?amount=" + encodeURIComponent(amount);
			}
		});
	
		// Fonction pour copier le lien d'affiliation et afficher un toast
		function copyToClipboard(text) {
			navigator.clipboard.writeText(text)
				.then(() => {
					const toastEl = document.getElementById('copyToast');
					const toast = new bootstrap.Toast(toastEl);
					toast.show();
				})
				.catch(err => {
					console.error('Échec de la copie : ', err);
				});
		}
	</script>
{% endblock %}