{% extends 'base.html.twig' %}

{% block title %}Dépôt
	{{ cryptoType }}
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		.deposit-container {
			max-width: 600px;
			margin: 2rem auto;
			padding: 2rem;
			background: #fff;
			border-radius: 8px;
			box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
		}
		.qr-code-container {
			margin: 1.5rem 0;
			text-align: center;
		}
		.address-container {
			display: flex;
			margin-bottom: 1.5rem;
		}
		.address-container input {
			flex-grow: 1;
			padding: 0.5rem;
			border: 1px solid #ddd;
			border-radius: 4px 0 0 4px;
		}
		.address-container button {
			border-radius: 0 4px 4px 0;
		}
		.timer {
			font-weight: bold;
			color: #dc3545;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container">
		<div class="deposit-container">
			<h2 class="text-center mb-4">Dépôt de
				{{ amountUSD|number_format(2) }}
				USD en
				{{ cryptoType }}</h2>

			<div class="alert alert-info">
				<p class="mb-1">Envoyez
					<strong>{{ amountUSD|number_format(2) }}
						USD</strong>
					en
					{{ cryptoType }}
					à l'adresse ci-dessous :</p>
			</div>

			<div class="qr-code-container">
				<div id="qrcode"></div>
			</div>

			<div class="address-container">
				<input type="text" value="{{ address }}" id="walletAddress" readonly class="form-control">
				<button onclick="copyAddress()" class="btn btn-primary">
					<i class="fas fa-copy"></i>
					Copier
				</button>
			</div>

			<div class="alert alert-warning">
				<p>Veuillez effectuer le dépôt dans les
					<span class="timer" id="timer">15:00</span>
				</p>
				<p class="mb-0">Transaction ID:
					<strong>{{ transactionId }}</strong>
				</p>
			</div>

			<div class="text-center">
				<a href="{{ path('app_profile') }}" class="btn btn-success">
					<i class="fas fa-check"></i>
					J'ai effectué le paiement
				</a>
			</div>
		</div>
	</div>

	 <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
	 <script>
	    // Générer le QR Code
	    new QRCode(document.getElementById("qrcode"), {
	        text: "{{ qrCodeData }}",
	        width: 200,
	        height: 200,
	        colorDark: "#000000",
	        colorLight: "#ffffff",
	        correctLevel: QRCode.CorrectLevel.H
	    });
	
	    // Copier l'adresse
	    function copyAddress() {
	        const input = document.getElementById('walletAddress');
	        input.select();
	        document.execCommand('copy');
	        alert('Adresse copiée dans le presse-papier');
	    }
	
	    // Timer de 15 minutes
	    let endTime = new Date("{{ expiresAt }}").getTime();
	    let timer = setInterval(function() {
	        let now = new Date().getTime();
	        let distance = endTime - now;
	        
	        if (distance < 0) {
	            clearInterval(timer);
	            document.getElementById('timer').innerHTML = "EXPIRÉ";
	            alert('Le délai pour ce dépôt a expiré. Veuillez générer une nouvelle adresse.');
	            return;
	        }
	        
	        let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
	        let seconds = Math.floor((distance % (1000 * 60)) / 1000);
	        
	        document.getElementById('timer').innerHTML = 
	            minutes.toString().padStart(2, '0') + ":" + seconds.toString().padStart(2, '0');
	    }, 1000);
	</script>
{% endblock %}
