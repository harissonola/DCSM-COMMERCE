{% extends 'base.html.twig' %}

    {% block title %}
      {{ app.user.fname }}
      {{ app.user.lname }}
      | Profil
    {% endblock %}
    
    {% block stylesheets %}
      {{ parent() }}
      <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
      <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/themeselection/sneat-html-admin-template-free@main/assets/vendor/libs/animate-css/animate.css" />
      
      <style>
        :root {
          --primary: #6c5ce7;
          --primary-dark: #5649c0;
          --secondary: #a29bfe;
          --accent: #00cec9;
          --dark: #0f0f1a;
          --darker: #0a0a12;
          --darkest: #05050a;
          --light: #f1f1f6;
          --lighter: #f8f9fa;
          --glass: rgba(15, 15, 26, 0.7);
          --glass-light: rgba(31, 31, 51, 0.5);
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.5);
          --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
          --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.3), 0 6px 6px rgba(0, 0, 0, 0.2);
          --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          --border-radius: 12px;
        }
        
        /* Profile specific styles */
        .profile-header {
          background: var(--glass);
          backdrop-filter: blur(12px);
          border-radius: var(--border-radius);
          border: 1px solid var(--glass-light);
          padding: 2rem;
          margin: 1.5rem auto;
          max-width: 1200px;
          opacity: 0;
          transform: translateY(20px);
          transition: var(--transition);
        }
    
        .profile-header.animate-fade {
          opacity: 1;
          transform: translateY(0);
        }
    
        .profile-avatar {
          width: 120px;
          height: 120px;
          object-fit: cover;
          border-radius: 50%;
          border: 3px solid var(--primary);
          box-shadow: 0 0 0 3px var(--darkest);
          transition: var(--transition);
        }
    
        .stats-card {
          background: var(--glass-light);
          border-radius: var(--border-radius);
          padding: 1.5rem;
          box-shadow: var(--shadow-sm);
          transition: var(--transition);
          border-left: 3px solid var(--primary);
        }
    
        .action-grid {
          display: grid;
          gap: 1.5rem;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    
        .action-btn {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 1.5rem;
          background: var(--glass-light);
          border-radius: var(--border-radius);
          transition: var(--transition);
          text-align: center;
          box-shadow: var(--shadow-sm);
          border: 1px solid var(--glass-light);
          color: var(--light);
        }
    
        /* Animations */
        @keyframes float {
          0% { transform: translateY(0px); }
          50% { transform: translateY(-8px); }
          100% { transform: translateY(0px); }
        }
    
        /* Responsive adjustments */
        @media (max-width: 768px) {
          .profile-header {
            padding: 1.5rem;
            margin: 1rem;
          }
        
          .profile-avatar {
            width: 80px;
            height: 80px;
          }
        
          .action-grid {
            grid-template-columns: 1fr;
          }
        }
      </style>
    {% endblock %}
    
    {% block body %}
      <!-- Profile Section -->
      <div class="profile-header animate-fade">
        <div class="d-flex flex-column flex-md-row align-items-center gap-4">
          <div class="position-relative">
            <img src="{{ app.user.photo }}" class="profile-avatar" alt="Profile photo" />
          </div>
          <div class="flex-grow-1 text-center text-md-start">
            <h1 class="h3 mb-1 fw-bold">
              {{ app.user.fname }}
              {{ app.user.lname }}
            </h1>
            <div class="d-flex flex-wrap gap-2 justify-content-center justify-content-md-start">
              <span class="badge bg-primary rounded-pill">@{{ app.user.username }}</span>
              <span class="badge bg-success rounded-pill">{{ app.user.country|country_name('fr') }}</span>
            </div>
            <div class="mt-3">
              <a href="{{ path('app_logout') }}" class="btn btn-outline-light btn-sm">
                <i class="fas fa-sign-out-alt me-1"></i>
                Déconnexion
              </a>
              {% if is_granted('ROLE_ADMIN') %}
                <a href="{{ path('admin_dashboard') }}" class="btn btn-primary btn-sm ms-2">
                  <i class="fa-solid fa-table-columns me-1"></i>
                  Administration
                </a>
              {% endif %}
            </div>
          </div>
          <div class="d-flex flex-wrap gap-4 justify-content-center justify-content-md-start">
            <div class="stats-card">
              <div class="d-flex align-items-center gap-3">
                <i class="fas fa-gift text-secondary"></i>
                <div>
                  <div class="text-muted small">Récompenses</div>
                  <div class="h4 mb-0 fw-bold">${{ app.user.reward|default(0)|number_format(2) }}</div>
                </div>
              </div>
            </div>
            <div class="stats-card">
              <div class="d-flex align-items-center gap-3">
                <i class="fas fa-wallet text-secondary"></i>
                <div>
                  <div class="text-muted small">Solde disponible</div>
                  <div class="h4 mb-0 fw-bold">${{ app.user.balance|number_format(2) }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    
      <!-- Action Section -->
      <div class="profile-header animate-fade" style="animation-delay: 0.1s">
        <div class="action-grid">
          <button class="action-btn" data-bs-toggle="modal" data-bs-target="#depositModal">
            <i class="fas fa-arrow-down-to-line fa-2x mb-2"></i>
            Déposer
          </button>
          <button class="action-btn" data-bs-toggle="modal" data-bs-target="#withdrawModal">
            <i class="fas fa-arrow-up-from-bracket fa-2x mb-2"></i>
            Retirer
          </button>
          <a href="{{ path('app_user_settings') }}" class="action-btn text-decoration-none">
            <i class="fas fa-user-edit fa-2x mb-2"></i>
            Modifier profil
          </a>
          <button class="action-btn" data-bs-toggle="modal" data-bs-target="#shareModal">
            <i class="fas fa-share-nodes fa-2x mb-2"></i>
            Parrainage
          </button>
        </div>
      </div>
    
      <!-- Referral Section -->
      <div class="profile-header animate-fade" style="animation-delay: 0.2s">
        {% set referrals = referralCount|default(0) %}
        {% if referrals < 5 %}
          {% set required = 5 %}
          {% set reward = 6 %}
          {% set level = 1 %}
        {% elseif referrals < 10 %}
          {% set required = 10 %}
          {% set reward = 7 %}
          {% set level = 2 %}
        {% elseif referrals < 20 %}
          {% set required = 20 %}
          {% set reward = 10 %}
          {% set level = 3 %}
        {% else %}
          {% set required = 40 %}
          {% set reward = 13 %}
          {% set level = 4 %}
        {% endif %}
        {% set progress = referrals / required * 100 %}
        {% if progress > 100 %}
          {% set progress = 100 %}
        {% endif %}
        <div class="mb-4">
          <h4 class="fw-bold">
            Niveau
            {{ level }}
            -
            {{ referrals }}
            sur
            {{ required }}
            personnes parrainées
          </h4>
          <div class="progress mb-3">
            <div class="progress-bar" role="progressbar" style="width: {{ progress|round(0, 'ceil') }}%;" aria-valuenow="{{ progress|round(0, 'ceil') }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="alert alert-dark border-0">
            <i class="fas fa-gift me-2 text-accent"></i>
            Récompense à l'atteinte de ce niveau :
            <strong>{{ reward }}%</strong>
            {% if level == 4 and referrals >= 40 %}
              <span class="badge bg-success ms-2">+ 10$ bonus</span>
            {% endif %}
          </div>
        </div>
      </div>
    
      {% if inactiveReferrals|length > 0 %}
        <div class="profile-header animate-fade" style="animation-delay: 0.25s">
          <div class="alert alert-warning">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <i class="fas fa-exclamation-triangle me-2"></i>
                Vous avez {{ inactiveReferrals|length }} filleul(s) inactif(s)
              </div>
              <button type="button" class="btn btn-warning btn-sm" id="sendReminderBtn" data-count="{{ inactiveReferrals|length }}">
                <i class="fas fa-paper-plane me-1"></i>
                Envoyer un rappel
              </button>
            </div>
          </div>
        </div>
      {% endif %}
    
      <!-- Products Section -->
      <div class="profile-header animate-fade" style="animation-delay: 0.3s">
        <h5 class="mb-3 fw-bold">Vos Produits</h5>
        <div class="row g-4">
          {% if app.user.product|length > 0 %}
            {% for product in app.user.product %}
              <div class="col-md-4">
                <div class="card product-card">
                  <div class="card-body">
                    <h5 class="card-title fw-bold">{{ product.name }}</h5>
                    <p class="card-text text-muted">
                      {{ product.description|slice(0, 100) }}
                      {% if product.description|length > 100 %}...{% endif %}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-success">${{ (product.price / 601.51)|number_format(2) }}</span>
                      <div class="d-flex">
                        <a href="{{ path('app_products_dashboard', { slug: product.slug }) }}" class="btn btn-sm btn-primary me-2">
                          <i class="fas fa-eye"></i>
                          Voir
                        </a>
                        <form method="post" action="{{ path('app_user_remove_product', { id: product.id }) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir retirer ce produit ?');">
                          <input type="hidden" name="_token" value="{{ csrf_token('delete-product-' ~ product.id) }}" />
                          <button type="submit" class="btn btn-sm btn-danger">
                            <i class="fas fa-trash-alt"></i>
                            Supprimer
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="col-12 text-center py-4">
              <div class="text-muted mb-3">Vous n'avez pas encore de produits</div>
              <a href="{{ path('app_products_index') }}" class="btn btn-primary">
                <i class="fas fa-shopping-cart me-2"></i>
                Découvrir les produits
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    
      <!-- Transactions Section -->
      <div class="profile-header animate-fade" style="animation-delay: 0.4s">
        <h5 class="mb-3 fw-bold">Historique des transactions</h5>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Méthode</th>
                <th>Montant</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody>
              {% for transaction in transactions %}
                <tr>
                  <td>{{ transaction.createdAt|date('d/m/Y H:i') }}</td>
                  <td>
                    {% if transaction.type == 'withdrawal' %}
                      <span class="badge bg-danger">Retrait</span>
                    {% else %}
                      <span class="badge bg-success">Dépôt</span>
                    {% endif %}
                  </td>
                  <td>{{ transaction.method }}</td>
                  <td class="fw-bold">
                    {% if transaction.type == 'withdrawal' %}
                      <span class="text-danger">-{{ transaction.amount|number_format(2) }}</span>
                    {% else %}
                      <span class="text-success">+{{ transaction.amount|number_format(2) }}</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge rounded-pill bg-{{ transaction.status == 'pending' ? 'warning' : transaction.status == 'failed' ? 'danger' : 'success' }}">
                      {{ transaction.status == 'pending' ? 'En attente' : transaction.status == 'failed' ? 'Échoué' : 'Réussi' }}
                    </span>
                  </td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="5" class="text-center py-4">
                    <div class="text-muted">Aucune transaction récente</div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    
      <!-- Deposit Modal -->
      <div class="modal fade" id="depositModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title fw-bold"><i class="fas fa-coins me-2 text-warning"></i>Déposer des fonds</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="depositForm" action="{{ path('app_deposit') }}" method="post">
                <input type="hidden" name="_token" value="{{ csrf_token('deposit') }}" />
                <div class="mb-4">
                  <label class="form-label fw-bold">Montant (USD)</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" name="amount" class="form-control" required step="0.01" min="{{ constant('App\\Controller\\PaymentController::MIN_DEPOSIT_AMOUNT') }}" max="{{ constant('App\\Controller\\PaymentController::MAX_DEPOSIT_AMOUNT') }}" />
                  </div>
                  <small class="text-muted">
                    Min: ${{ constant('App\\Controller\\PaymentController::MIN_DEPOSIT_AMOUNT') }}
                    - Max: ${{ constant('App\\Controller\\PaymentController::MAX_DEPOSIT_AMOUNT') }}
                  </small>
                </div>
                <div class="mb-4">
                  <label class="form-label fw-bold">Méthode de paiement</label>
                  <div class="d-grid gap-2">
                    {% for method in [{ id: 'crypto', label: 'Crypto', icon: 'bitcoin' }, { id: 'paypal', label: 'PayPal', icon: 'paypal' }] %}
                      <div class="form-check p-3 rounded bg-dark">
                        <input class="form-check-input" type="radio" name="method" id="{{ method.id }}" value="{{ method.id }}" required />
                        <label class="form-check-label d-flex align-items-center fw-bold" for="{{ method.id }}">
                          <i class="fab fa-{{ method.icon }} me-3 fs-4"></i>
                          {{ method.label }}
                        </label>
                      </div>
                    {% endfor %}
                  </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                  <i class="fas fa-arrow-right me-2"></i>
                  Continuer
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    
      <!-- Withdraw Modal -->
      <div class="modal fade" id="withdrawModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title fw-bold"><i class="fas fa-wallet me-2 text-success"></i>Retirer des fonds</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form action="{{ path('app_withdraw') }}" method="post">
                <input type="hidden" name="_token" value="{{ csrf_token('withdraw') }}" />
                <div class="mb-3">
                  <label class="form-label fw-bold">Montant (USD)</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" name="amount" class="form-control" step="0.01" required min="{{ constant('App\\Controller\\PaymentController::MIN_WITHDRAWAL_AMOUNT') }}" max="{{ constant('App\\Controller\\PaymentController::MAX_WITHDRAWAL_AMOUNT') }}" />
                  </div>
                  <small class="text-muted">
                    Min: ${{ constant('App\\Controller\\PaymentController::MIN_WITHDRAWAL_AMOUNT') }}
                    - Max: ${{ constant('App\\Controller\\PaymentController::MAX_WITHDRAWAL_AMOUNT') }}
                  </small>
                </div>
                <div class="mb-3">
                  <label class="form-label fw-bold">Type de crypto</label>
                  <select id="cryptoType" name="currency" class="form-select" required>
                    <option value="">Sélectionnez une crypto</option>
                    {% for key, label in constant('App\\Controller\\PaymentController::SUPPORTED_CRYPTOS') %}
                      <option value="{{ key }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-4">
                  <label class="form-label fw-bold">Adresse de réception</label>
                  <input type="text" name="address" class="form-control" placeholder="Ex: 0x... (ETH) ou 1... (BTC)" required />
                </div>
                <div class="alert alert-dark mb-4">
                  <i class="fas fa-info-circle me-2"></i>
                  Frais de retrait: 5% (≤20$), 3% (≤100$), 2% (≤500$), 1% (>500$)
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                  <i class="fas fa-check-circle me-2"></i>
                  Confirmer
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    
      <!-- Share Modal -->
      <div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title fw-bold"><i class="fas fa-share-alt me-2 text-info"></i>Partager mon lien</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="input-group mb-4">
                <input type="text" class="form-control" value="{{ referralLink }}" id="referralLink" readonly />
                <button class="btn btn-primary" onclick="copyToClipboard()">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
              <div class="d-grid gap-2">
                <a href="https://wa.me/?text={{ ('Rejoignez-moi: ' ~ referralLink)|url_encode }}" class="btn btn-success" target="_blank">
                  <i class="fab fa-whatsapp me-2"></i>
                  WhatsApp
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ referralLink|url_encode }}" class="btn btn-primary" target="_blank">
                  <i class="fab fa-facebook-f me-2"></i>
                  Facebook
                </a>
                <a href="https://twitter.com/intent/tweet?text={{ ('Découvrez cette plateforme: ' ~ referralLink)|url_encode }}" class="btn btn-info" target="_blank">
                  <i class="fab fa-twitter me-2"></i>
                  Twitter
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    
      <!-- Toast Notification -->
      <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="copyToast" class="toast bg-primary" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body d-flex align-items-center">
              <i class="fas fa-check-circle me-2"></i>
              Lien copié dans le presse-papier
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      </div>
    {% endblock %}
    
    {% block javascripts %}
      {{ parent() }}
      <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/i18n/fr.min.js"></script>
    
      <script>
        document.addEventListener('turbo:load', function() {
          // Initialize Select2
          $('#cryptoType').select2({
            dropdownParent: $('#withdrawModal'),
            width: '100%',
            language: 'fr'
          });
    
          // Copy to clipboard function
          window.copyToClipboard = function() {
            const referralLinkInput = document.getElementById('referralLink');
            if (referralLinkInput) {
              navigator.clipboard.writeText(referralLinkInput.value).then(() => {
                const toast = new bootstrap.Toast(document.getElementById('copyToast'));
                toast.show();
              });
            }
          };
    
          // Handle reminder button
          const sendReminderBtn = document.getElementById('sendReminderBtn');
          if (sendReminderBtn) {
            sendReminderBtn.addEventListener('click', function() {
              const count = this.dataset.count;
              
              Swal.fire({
                title: 'Confirmer l\'envoi',
                text: `Voulez-vous envoyer un rappel à ${count} filleul(s) inactif(s) ?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Confirmer',
                cancelButtonText: 'Annuler',
                customClass: {
                  confirmButton: 'btn btn-primary me-3',
                  cancelButton: 'btn btn-label-secondary'
                },
                buttonsStyling: false
              }).then((result) => {
                if (result.isConfirmed) {
                  // Create and submit form
                  const form = document.createElement('form');
                  form.method = 'POST';
                  form.action = '{{ path('app_send_message_to_inactive') }}';
                  
                  const csrfInput = document.createElement('input');
                  csrfInput.type = 'hidden';
                  csrfInput.name = '_token';
                  csrfInput.value = '{{ csrf_token('send_inactive_message') }}';
                  form.appendChild(csrfInput);
                  
                  document.body.appendChild(form);
                  form.submit();
                }
              });
            });
          }
    
          // Animate elements on scroll
          const animateOnScroll = () => {
            const elements = document.querySelectorAll('.profile-header');
            elements.forEach((el) => {
              const elTop = el.getBoundingClientRect().top;
              const windowHeight = window.innerHeight;
    
              if (elTop < windowHeight - 100) {
                el.classList.add('animate-fade');
              }
            });
          };
    
          window.addEventListener('scroll', animateOnScroll);
          animateOnScroll();
        });
      </script>
    {% endblock %}