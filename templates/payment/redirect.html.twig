{% extends 'base.html.twig' %}

{% block title %}Effectuer un dépôt
{% endblock %}

{% block body %}
	<div class="container my-5">
		<div class="row justify-content-center">
			<div class="col-md-8">
				<div class="card text-center p-4">
					<h4 class="mb-3">Envoyez votre dépôt</h4>

					<div class="my-3" id="qrcode"></div>

					<p class="lead">
						Montant à envoyer :
						<strong>{{ amountCrypto }}
							{{ currency|upper }}</strong>
						{% if amountUSD %}
							<small class="text-muted">(~{{ amountUSD }}
								USD)</small>
						{% endif %}
					</p>

					<div class="input-group mb-3">
						<input id="walletAddress" type="text" class="form-control" value="{{ address }}" readonly>
						<button class="btn btn-outline-secondary" type="button" onclick="copyAddress()">Copier</button>
					</div>

					<p>Réseau :
						<strong>{{ network|upper }}</strong>
					</p>

					<div class="alert alert-warning mt-4" role="alert">
						Veuillez effectuer le dépôt dans les
						<strong>
							<span id="timer">15:00</span>
						</strong>, sinon la session expirera.
					</div>

					<form method="post" action="{{ path('app_deposit_check_status') }}">
						<input type="hidden" name="transactionId" value="{{ transactionId }}">
						<button type="submit" class="btn btn-primary mt-3">J'ai effectué le paiement</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- QRCode.js depuis CDN -->
 <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

	 <script>
	  // Générer le QR code
	  new QRCode(document.getElementById("qrcode"), {
	    text: "{{ address }}",
	    width: 200,
	    height: 200,
	    colorDark: "#000000",
	    colorLight: "#ffffff",
	    correctLevel: QRCode.CorrectLevel.H
	  });
	
	  // Copier adresse
	  function copyAddress() {
	    const input = document.getElementById("walletAddress");
	    input.select();
	    input.setSelectionRange(0, 99999); // For mobile
	    navigator.clipboard.writeText(input.value);
	    alert("Adresse copiée !");
	  }
	
	  // Timer 15 minutes
	  let duration = 60 * 15;
	  const display = document.getElementById("timer");
	  const timer = setInterval(function () {
	    const minutes = Math.floor(duration / 60);
	    const seconds = duration % 60;
	    display.textContent = 
	      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
	    if (--duration < 0) {
	      clearInterval(timer);
	      display.textContent = "Expiré";
	      alert("Temps écoulé. Veuillez générer une nouvelle adresse.");
	      // Rediriger ou bloquer bouton
	    }
	  }, 1000);
	</script>
{% endblock %}